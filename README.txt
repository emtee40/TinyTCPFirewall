*これは何?*
WindowsのTCP接続を監視し、特定の条件を満たした場合に切断を行うファイアウォールのようなプログラムです。通常のファイアウォールとは異なり、転送量、転送速度に特化した条件を設定することができます。

*使い方*
TinyTCPFirewall.exeをダブルクリックして起動します。あとは終了するまで勝手に動作します。動作ログはDOS窓内に表示されるほか、プログラムと同じディレクトリにlog.txtという名前で保存されます。

*注意*
・動作には管理者権限が必要です。管理者権限がない場合、起動しません。
・監視するローカルのIPアドレスは自動検出されますが、NICが複数存在する等の理由で対象としたいアドレスがうまく選ばれない場合、Rules.iniファイルのGlobalセクション内のMyIPAddressキーにIPアドレスを直接指定することができます。
・OSの環境や設定にもよるかと思いますが、下り(受信)方向の監視については、OSのファイアウォールの例外にこのプログラム(TinyTCPFirewall.exe)を追加しておかないとパケットが降ってこない可能性があります。

*ルールの書き方*
切断の条件を設定するためのルールは、実行ファイルと同じディレクトリにあるRules.iniファイル内に記述します。ルールはRuleで始まるセクション内に記述する必要があります。

以下、ルールで使用するキーについて説明します。

ExeName キー (文字列値, 必須)
対象とするプログラムのexeファイル名を指定します。大小文字を区別するので注意してください。
 例) ExeName = "foo.exe"
  -> foo.exe という実行ファイル名のプログラムを対象とします。

Direction キー (整数値, 規定値=0)
監視する通信の方向を指定します。0が下り(受信)方向、1が上り(送信)方向です。
 例) Direction = 1
  -> 上り方向の通信を監視します。

When キー (整数値, 規定値=0)
ルールを適用するタイミングを通信開始からの秒数で指定します。0を指定した場合、ルールは常時適用されます。0以外の値を指定した場合、ルールが評価されるのはその時間の一度のみです。
 例) When = 10
  -> 通信開始から10秒経過した時点でこのルールを適用します。

TransferRateUpper キー (整数値, 規定値=0)
平均転送速度の上限をKB/s単位で指定します。条件を満たした場合、コネクションは切断されます。受信速度、送信速度のいずれを意味するかは、Directionキーの値によります。0を指定した場合、この条件は無視されます。
 例) TransferRateUpper = 100
  -> 平均転送速度が 100 KB/s を超過した場合、そのコネクションを切断します。

TransferAmountUpper (整数値, 規定値=0)
転送量の上限をKB単位で指定します。条件を満たした場合、コネクションは切断されます。受信量、送信量のいずれを意味するかは、Directionキーの値によります。0を指定した場合、この条件は無視されます。
 例) TransferAmountUpper = 1000
  -> 転送量が 1000 KB を超過した場合、そのコネクションを切断します。

TransferRateLower キー (整数値, 規定値=0)
平均転送速度の下限をKB/s単位で指定します。条件を満たした場合、コネクションは切断されます。受信速度、送信速度のいずれを意味するかは、Directionキーの値によります。0を指定した場合、この条件は無視されます。
 例) TransferRateLower = 100
  -> 平均転送速度が 100 KB/s を下回った場合、そのコネクションを切断します。

TransferAmountLower (整数値, 規定値=0)
転送量の下限をKB単位で指定します。条件を満たした場合、コネクションは切断されます。受信量、送信量のいずれを意味するかは、Directionキーの値によります。0を指定した場合、この条件は無視されます。
 例) TransferAmountLower = 1000
  -> 転送量が 1000 KB を下回った場合、そのコネクションを切断します。

実際にルールを記述した例を幾つか示します。

例1) hoge.exeで通信開始から5秒で送信速度が250KB/sを上回ったコネクションを切断する
[Rule1]
ExeName = "hoge.exe"
Direction = 1
When = 5
TransferRateUpper = 250

例2) hoge.exeで総受信量が10000KBを超えたコネクションを切断する
[Rule2]
ExeName = "hoge.exe"
Direction = 0
When = 0
TransferAmountUpper = 10000

Whenに0以外を指定する場合は、TransferRate系のキーで条件を指定するのと、TransferAmount系のキーで指定するのとでは、意味は(ほぼ)同じです。指定しやすい方を使ってください。

これ以外に、iniファイルのGlobalセクションにBlackListThresholdというキーがあります。これに0以外の値を指定すると、切断数が指定した回数に達したIPアドレスについては、以降即時切断されるようになります。
